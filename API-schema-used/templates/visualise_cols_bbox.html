<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossOrigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossOrigin=""></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
<script type="text/javascript" src="{{ url_for('static', filename='3rd/jquery.js') }}"></script>


<div id="map" style="width: 900px; height: 500px"></div>

<script>
    var nomalcolor = {
        'color': 'blue',
        'weight': 3
    }
    var map = L.map('map', {
        center: [52, 4.8],
        zoom: 8
    });


    var cols_info = {{datasets|tojson}}
    var cols= cols_info["collections"]

    var group = new L.FeatureGroup();
    $.each(cols, function (i) {
        let bound=cols[i]["extent_WGS84"]
        console.log(bound)
        let title=cols[i]["title"]
        let Latlng=[[bound[1],bound[0]],[bound[3],bound[2]]]
        let feature = L.rectangle(Latlng, nomalcolor);
        feature.type = feature.type || "Feature";
        var props = feature.properties = feature.properties || {};
        props.name = title;
        group.addLayer(feature);
    });

    map.addLayer(group);
    var highlight = {
        'color': '#333333',
        'weight': 5,
        'opacity': 1
    };

    group.on('dblclick', function (e) {
        window.location.href = window.location.href + e.layer.properties.name;
    });
    group.on('click', function (e) {
        group.eachLayer(function (layer) {
            layer.setStyle(nomalcolor)
        });
        e.layer.setStyle(highlight);
    });


    // Set up the OSM layer
    L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(map);

    // Initialise the FeatureGroup to store editable layers
    var editableLayers = new L.FeatureGroup();
    map.addLayer(editableLayers);
    var drawPluginOptions = {
        position: 'topright',
        draw: {
            polyline: false,
            polygon: false,
            circle: false, // Turns off this drawing tool
            rectangle: {
                shapeOptions: {
                    clickable: false
                }
            },
            marker: false
        },
        edit: {
            featureGroup: editableLayers, //REQUIRED!!
            remove: true
        }
    };
    // Initialise the draw control and pass it the FeatureGroup of editable layers
    var drawControl = new L.Control.Draw(drawPluginOptions);
    map.addControl(drawControl);


    var bbox;
    map.on('draw:created', function (e) {
        layer = e.layer;
        editableLayers.addLayer(layer);
        latlngs = layer.getLatLngs()[0]
        // console.log(latlngs)
        bbox = [latlngs[0]['lat'].toFixed(5), latlngs[0]['lng'].toFixed(5), latlngs[1]['lat'].toFixed(5), latlngs[2]['lng'].toFixed(5)]
        $("#epsg").val("4326");
        $("#minY").val(bbox[0]);
        $("#minX").val(bbox[1]);
        $("#maxY").val(bbox[2]);
        $("#maxX").val(bbox[3]);
    });


</script>